name: Tests

on: [pull_request, push]

jobs:
  test-node:
    name: Tests Node
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [18, 20]
    steps:
      - uses: actions/checkout@v3
      - run: corepack enable
      - uses: actions/setup-node@v4
        with:
          node-version: ${{matrix.node}}
          cache: pnpm
      - name: Bootstrap
        run: pnpm install --frozen-lockfile
      - name: Build
        run: pnpm build
      - name: Generate
        run: pnpm generate
      - name: Check types
        run: pnpm check-types
      - name: Lint
        run: pnpm lint
      - name: Unit Tests
        run: pnpm test:unit
      - name: Browsers Tests
        run: pnpm test:browsers
      # Download spec tests with cache
      - name: Restore spec tests cache
        uses: actions/cache@master
        with:
          path: packages/ssz/spec-tests
          key: spec-test-data-${{ hashFiles('packages/ssz/test/specTestVersioning.ts') }}
      - name: Download spec tests
        run: pnpm download-spec-tests
        working-directory: packages/ssz
      # Run them in different steps to quickly identifying which command failed
      # Otherwise just doing `pnpm test:spec` you can't tell which specific suite failed
      # many of the suites have identical names for minimal and mainnet
      - name: Spec tests general
        run: pnpm test:spec-generic
        working-directory: packages/ssz
      - name: Spec tests phase0-minimal
        run: LODESTAR_FORK=phase0 pnpm test:spec-static-minimal
        working-directory: packages/ssz
      - name: Spec tests phase0-mainnet
        run: LODESTAR_FORK=phase0 pnpm test:spec-static-mainnet
        working-directory: packages/ssz
      - name: Spec tests altair-minimal
        run: LODESTAR_FORK=altair pnpm test:spec-static-minimal
        working-directory: packages/ssz
      - name: Spec tests altair-mainnet
        run: LODESTAR_FORK=altair pnpm test:spec-static-mainnet
        working-directory: packages/ssz
      - name: Spec tests bellatrix-minimal
        run: LODESTAR_FORK=bellatrix pnpm test:spec-static-minimal
        working-directory: packages/ssz
      - name: Spec tests bellatrix-mainnet
        run: LODESTAR_FORK=bellatrix pnpm test:spec-static-mainnet
        working-directory: packages/ssz
  
  test-bun:
    name: Tests Bun
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2      
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install pnpm
        run: bun install -g npm:pnpm
      - name: Install
        run: pnpm install --frozen-lockfile
      - name: Build
        run: pnpm build
      - name: Generate
        run: pnpm generate
      - name: Unit Tests
        run: pnpm test:unit

  test-deno:
    name: Tests Deno
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Install pnpm
        run: deno install -g npm:pnpm
      - name: Install
        run: pnpm install --frozen-lockfile
      - name: Build
        run: pnpm build
      # Deno does not run task in workspaces if same task exists on root package.json
      - name: Clean root scripts 
        run: cat package.json | jq 'del( .scripts )' > package.json.backup && mv package.json.backup package.json
      - name: Generate
        run: deno task --recursive generate
      - name: Unit Tests
        run: deno task --recursive test:unit
